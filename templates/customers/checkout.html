{% extends 'quicklink/customers.html' %}
{% load static %}

{% block pagetitle %}Checkout{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/css/intlTelInput.css" integrity="sha512-gxWow8Mo6q6pLa1XH/CcH8JyiSDEtiwJV78E+D+QP0EVasFs8wKXq16G8CLD4CJ2SnonHr4Lm/yY2fSI2+cbmw==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/css/intlTelInput.min.css" integrity="sha512-yye/u0ehQsrVrfSd6biT17t39Rg9kNc+vENcCXZuMz2a+LWFGvXUnYuWUW6pbfYj1jcBb/C39UZw2ciQvwDDvg==" crossorigin="anonymous" />
<style>
    .iti__flag {background-image: url("https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/img/flags.png");}

    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .iti__flag {background-image: url("https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/img/flags@2x.png");}
    }
</style>
{% endblock %}

{% block scriptsHead %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/js/intlTelInput.min.js" integrity="sha512-OnkjbJ4TwPpgSmjXACCb5J4cJwi880VRe+vWpPDlr8M38/L3slN5uUAeOeWU2jN+4vN0gImCXFGdJmc0wO4Mig==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/js/utils.js" integrity="sha512-bUcJxlqkiGA3cmoYPuZaLRsyc5ChG9APG4ajom2AXKSlBtOmx4kLV3c8uv/6uSz43FMjI4Q2QI21+D223rT76w==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/js/utils.min.js" integrity="sha512-JtpGKUjQUqCJmgw3TOr8bkL8QqB8oCbofRU39xgDnRYTfIDvfg0gQs2efeKxBCdwSAP/h3CSqhn87+giWSsxjw==" crossorigin="anonymous"></script>
{% endblock %}

{% block maincontent %}
    <form method="post" onload="verifyNumber()">
        {% csrf_token %}
        <h1>Fill up your details</h1>
        {{ form.name }}<br><br>
        {{ form.email }}<br><br>
        {{ form.contact_number }}<br><br><br>
        
        <h1>Shipping Address</h1>
        {{ form.line1 }}<br><br>
        {{ form.line2 }}<br><br>
        {{ form.city }}<br><br>
        {{ form.province }}
        {{ form.postal_code }}<br><br><br>
        
        <h1>Preferred Delivery Date</h1>
        {{ form.delivery_date }}

        <h1>Mode of Payment</h1>
        {{ form.bank_name }}<br><br>

        <h1>Receive Updates</h1>
        {{ form.notif_sms }} {{ form.notif_sms.label }}<br>
        {{ form.notif_email }} {{ form.notif_email.label }}<br><br><br>
        <button type="submit" class="primary-btn primary-btn-link">Proceed to Payment</button>
    </form>
{% endblock %}

{% block scriptsBody %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/js/intlTelInput.js" integrity="sha512-lib7WdJvAnfLLBi5AHdN+wUkcWwpu1fmYzyEHQijZq7WedcwBiwdVNbcML2rAtKvwtOIU7thMGB+O9Kpb9g2Cw==" crossorigin="anonymous"></script>
    <script>
        var contactNumberInput = document.querySelector("#id_contact_number");
        var postalCodeInput = document.querySelector("#id_postal_code");

        // To edit the style of intlTelInput, edit .iti {}
        // Check the documentation for more info: https://github.com/jackocnr/intl-tel-input

        var iti = intlTelInput(contactNumberInput, {
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/js/utils.js",
            initialCountry: "auto",
            geoIpLookup: function(success, failure) {
                $.get("https://ipinfo.io", function() {}, "jsonp").always(function(resp) {
                    var countryCode = (resp && resp.country) ? resp.country : "us";
                    success(countryCode);
                });
            },
            separateDialCode: true,
        })

        function verifyPhoneNumber() {
            // PHONE NUMBER JQUERY
            var contactNumber = iti.getNumber(intlTelInputUtils.numberFormat.E164);
            if (contactNumber.indexOf(' ') >= 0) {
                contactNumber = contactNumber.trim()
            }

            if (iti.isValidNumber()) {
                contactNumberInput.classList.remove("error");
            } else {
                contactNumberInput.classList.add("error");
            }
        }

        function validateData() {
            // EMAIL VALIDATION
            var emailAccessKey = 'dafbd1f494654f72b5e4b44b9424f292';
            var emailInput = $("#id_email").val();
            var emailValidationUrl = "https://emailvalidation.abstractapi.com/v1?api_key=" + emailAccessKey + "&email=" + emailInput;

            $.getJSON(emailValidationUrl, function(data) {
                if (data.deliverability == "DELIVERABLE") {
                    document.querySelector("#id_email").classList.remove("error");
                } else {
                    document.querySelector("#id_email").classList.add("error");
                }
            })

            // PHONE VALIDATION
            var phoneAccessKey = '98ff0e216227414cb5825d406e163799';
            var phoneInput = String(iti.getNumber(intlTelInputUtils.numberFormat.E164)).split("+")[1];
            console.log(phoneInput)
            var phoneValidationUrl = "https://phonevalidation.abstractapi.com/v1?api_key=" + phoneAccessKey + "&phone=" + phoneInput;

            $.getJSON(phoneValidationUrl, function(data) {
                if (data.valid == true) {
                    document.querySelector("#id_email").classList.remove("error");
                } else {
                    document.querySelector("#id_email").classList.add("error");
                }
            })
        }

        window.onload = function() {
            contactNumberInput.onkeyup = function() {
                setTimeout(verifyPhoneNumber(), 500);
            };

            postalCodeInput.onkeyup = function() {
                setTimeout(validateData(), 500);
            };
        }
    </script>
{% endblock %}