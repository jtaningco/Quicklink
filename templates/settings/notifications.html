{% extends 'quicklink/app.html' %}
{% load static %}

{% block pagetitle %}{{shop.shop_name|title}}: Account Settings{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{% static '/css/merchant-settings/account.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noty/3.1.4/noty.min.css" integrity="sha512-0p3K0H3S6Q4bEWZ/WmC94Tgit2ular2/n0ESdfEX8l172YyQj8re1Wu9s/HT9T/T2osUw5Gx/6pAZNk3UKbESw==" crossorigin="anonymous">
{% endblock %}

{% block scriptsHead %}{% endblock %}

{% block maincontent %}
    <div class="settings__container">
        <h1 class="settings__header extra-bold">Notifications</h1>
        <div class="settings__wrapper">
            <div class="settings__content">
                <div class="settings__content__row">
                    <h2 class="settings__content__header subtitle bold">Received Payouts</h2>
                    <div class="switch-whole">
                        <label class="switch">
                            <input type="checkbox" name="received_payouts" id="id_received_payouts">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <p class="subtitle" style="color: var(--muted-light);">Get an email notification every time we send your revenue to your bank account.</p>
            </div>

            <div class="settings__content">
                <div class="settings__content__row">
                    <h2 class="settings__content__header subtitle bold">Daily Order Summary</h2>
                    <div class="switch-whole">
                        <label class="switch">
                            <input type="checkbox" name="received_payouts" id="id_received_payouts">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <p class="subtitle" style="color: var(--muted-light);">Get an email that outlines your orders for the day.</p>
            </div>
            
            <div class="settings__content">
                <div class="settings__content__row">
                    <h2 class="settings__content__header subtitle bold">Product Updates</h2>
                    <div class="switch-whole">
                        <label class="switch">
                            <input type="checkbox" name="received_payouts" id="id_received_payouts">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <p class="subtitle" style="color: var(--muted-light);">Get informed whenever we release a new feature on Quicklink!</p>
            </div>

            <div class="settings__content">
                <div class="settings__content__row">
                    <h2 class="settings__content__header subtitle bold">Marketing Updates</h2>
                    <div class="switch-whole">
                        <label class="switch">
                            <input type="checkbox" name="received_payouts" id="id_received_payouts">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <p class="subtitle" style="color: var(--muted-light);">Stay updated with news about Quicklink!</p>
            </div>
        </div>
    </div>

    {% if form.errors %}
        <div id="form-errors" style="display: none;">{{ form.errors.as_json }}</div>
    {% endif %}

    {% for message in messages %}
        <div class="js-success-msgs" style="display: none;">{{ message }}</div>
    {% endfor %}

{% endblock %}

{% block scriptsBody %}
    <script>
        // Modal Variables
        const modalContainer = $("#js-modal-container");
        const modalCard = $("#js-modal-card");
        const exitModalBtn = $("#js-modal-exit-btn");

        // Edit Password Variables
        const editPasswordForm = $("#js-modal-edit-password");
        const editPasswordBtn = $("#js-edit-password-btn");

        // Delete Account Variables
        const delAccountForm = $("#js-modal-del-account");
        const delAccountBtn = $("#js-del-account-btn");

        function showEditPasswordModal() {
            modalContainer.css("display", "flex");
            modalContainer.css("opacity", "1");
            modalCard.css("display", "flex");
            editPasswordForm.css("display", "flex");
        }

        function hideEditPasswordModal() {
            modalContainer.css("display", "none");
            modalContainer.css("opacity", "0");
            modalCard.css("display", "none");
            editPasswordForm.css("display", "none");
        }

        function showDelAccountModal() {
            modalContainer.css("display", "flex");
            modalContainer.css("opacity", "1");
            modalCard.css("display", "flex");
            delAccountForm.css("display", "flex");
        }

        function hideDelAccountModal() {
            modalContainer.css("display", "none");
            modalContainer.css("opacity", "0");
            modalCard.css("display", "none");
            delAccountForm.css("display", "none");
        }

        editPasswordBtn.click(function() {
            showEditPasswordModal();
        });

        delAccountBtn.click(function() {
            showDelAccountModal();
        })

        exitModalBtn.click(function() {
            hideEditPasswordModal();
            hideDelAccountModal();
        });

        modalContainer.click(function(e) {
            if (! document.getElementById("js-modal-card").contains(e.target)) {
                hideEditPasswordModal();
                hideDelAccountModal();
            }
        });

        // Account Deletion
        const current_url = window.location.href;
        const cancelDeleteBtn = $("#js-cancel-delete");
        const deleteAccountBtn = $("#js-delete-account");

        cancelDeleteBtn.click(function() {
            hideDelAccountModal();
        })

        deleteAccountBtn.click(function() {
            $.ajax({
                url: current_url,
                type: "POST",
                data: {"message": "delete_account"},
                success:function(response){
                    console.log("Message data successfully sent.")
                },
                error:function (xhr, textStatus, thrownError){
                    console.log("Can't send message data.", xhr, textStatus, thrownError);
                }
            });
        })
    </script>

    <!-- Password Form Validation -->
    <script>
        const passwordBtn = $("#js-password-btn");
        const oldPassInput = $("#id_old_password");
        const newPassInput = $("#id_new_password1");
        const confirmNewPassInput = $("#id_new_password2");

        $(":input").keyup(function() {
            if (oldPassInput.val().length > 0 && newPassInput.val().length > 0 && confirmNewPassInput.val().length > 0 && newPassInput.val().length == confirmNewPassInput.val().length) {
                passwordBtn.removeClass("disabled");
            }
        })
    </script>

    <!-- NOTY Notifications -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noty/3.1.4/noty.min.js" integrity="sha512-lOrm9FgT1LKOJRUXF3tp6QaMorJftUjowOWiDcG5GFZ/q7ukof19V0HKx/GWzXCdt9zYju3/KhBNdCLzK8b90Q==" crossorigin="anonymous"></script>

    <!-- NOTY Errors -->
    <script>
        const errors = $('#form-errors').text();
        const jsonErrors = JSON.parse(errors);

        var errorMessages = [];

        for (var k in jsonErrors) {
            for (var i in Object.keys(jsonErrors[k])) {
                errorMessages.push([jsonErrors[k][i]['message']]);
            }
        }

        function displayErrors() {
            for (i = 0; i < Object.keys(errorMessages).length; i++) {
                if (errorMessages[i] != undefined) {
                    new Noty({
                        type: 'error',
                        theme: 'bootstrap-v4',
                        text: errorMessages[i],
                        layout: "bottomRight",
                        timeout: 3000,
                        progressBar: true,
                    }).show();
                }
            }
        }

        if (errors != "" || errors != undefined || errors != null) { displayErrors(); }
    </script>

    <!-- NOTY Successes -->
    <script>
        const successes = $(".js-success-msgs");
        var successMessages = [];

        successes.each(function() {
            successMessages.push($(this).text());
        });

        function displaySuccesses() {
            for (i = 0; i < successMessages.length; i++) {
                if (successMessages[i] != undefined) {
                    new Noty({
                        type: 'success',
                        theme: 'sunset',
                        text: successMessages[i],
                        layout: "bottomRight",
                        timeout: 3000,
                        progressBar: true,
                    }).show();
                }
            }
        }

        if (successes != "" || successes != undefined || successes != null) { displaySuccesses(); }
    </script>
{% endblock %}